#!/bin/bash
# Test script for the MCP server
# This script tests the JSON-RPC protocol for MCP initialization and tool listing

#set -e

MCP_SERVER="${1:-vengi-voxeditmcp}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Counters
TESTS_PASSED=0
TESTS_FAILED=0

log_info() {
    echo -e "${YELLOW}[INFO]${NC} $1"
}

log_pass() {
    echo -e "${GREEN}[PASS]${NC} $1"
    ((TESTS_PASSED++))
}

log_fail() {
    echo -e "${RED}[FAIL]${NC} $1"
    ((TESTS_FAILED++))
}

# Check if jq is available for JSON parsing
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required but not installed. Please install jq."
    exit 1
fi

# Check if the MCP server binary exists
if [ ! -x "$MCP_SERVER" ]; then
    echo "Error: MCP server not found at '$MCP_SERVER'"
    echo "Set MCP_SERVER environment variable to the path of the vengi-voxeditmcp binary"
    exit 1
fi

log_info "Testing MCP server at: $MCP_SERVER"
echo ""

# Create a temporary directory for test files
TMPDIR=$(mktemp -d)
trap "rm -rf $TMPDIR" EXIT

# Function to send a request and get response
send_request() {
    local request="$1"
    local timeout="${2:-5}"
    echo "$request"
}

# Test 0: Startup
log_info "Test 0: Starting MCP server..."
timeout 5 "$MCP_SERVER"

# Test 1: Initialize request
log_info "Test 1: Sending initialize request..."

INIT_REQUEST='{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test-client","version":"1.0.0"}}}'

INIT_RESPONSE=$(echo -e "$INIT_REQUEST" | timeout 5 "$MCP_SERVER" 2>/dev/null | head -1)

if [ -z "$INIT_RESPONSE" ]; then
    log_fail "No response received for initialize request"
else
    # Validate JSON
    if echo "$INIT_RESPONSE" | jq . > /dev/null 2>&1; then
        # Check for required fields
        JSONRPC=$(echo "$INIT_RESPONSE" | jq -r '.jsonrpc')
        ID=$(echo "$INIT_RESPONSE" | jq -r '.id')
        HAS_RESULT=$(echo "$INIT_RESPONSE" | jq 'has("result")')

        if [ "$JSONRPC" = "2.0" ] && [ "$ID" = "1" ] && [ "$HAS_RESULT" = "true" ]; then
            PROTOCOL_VERSION=$(echo "$INIT_RESPONSE" | jq -r '.result.protocolVersion')
            SERVER_NAME=$(echo "$INIT_RESPONSE" | jq -r '.result.serverInfo.name')
            log_pass "Initialize response valid (server: $SERVER_NAME, protocol: $PROTOCOL_VERSION)"
        else
            log_fail "Initialize response missing required fields"
            echo "  Response: $INIT_RESPONSE"
        fi
    else
        log_fail "Initialize response is not valid JSON"
        echo "  Response: $INIT_RESPONSE"
    fi
fi

echo ""

# Test 2: Initialize + notifications/initialized + tools/list
log_info "Test 2: Full initialization sequence with tools/list..."

# Create input with multiple requests
cat > "$TMPDIR/requests.txt" << 'EOF'
{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test-client","version":"1.0.0"}}}
{"jsonrpc":"2.0","method":"notifications/initialized"}
{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}
EOF

# Run the MCP server with the requests
# Note: The server needs VoxEdit running to get the full tools list
RESPONSES=$(timeout 10 "$MCP_SERVER" < "$TMPDIR/requests.txt" 2>/dev/null || true)

# Parse responses (one per line)
INIT_RESP=$(echo "$RESPONSES" | sed -n '1p')
TOOLS_RESP=$(echo "$RESPONSES" | sed -n '2p')

if [ -n "$INIT_RESP" ]; then
    if echo "$INIT_RESP" | jq . > /dev/null 2>&1; then
        log_pass "Initialize response received and valid JSON"
    else
        log_fail "Initialize response is not valid JSON"
    fi
else
    log_fail "No initialize response received"
fi

if [ -n "$TOOLS_RESP" ]; then
    if echo "$TOOLS_RESP" | jq . > /dev/null 2>&1; then
        HAS_TOOLS=$(echo "$TOOLS_RESP" | jq 'has("result") and .result | has("tools")')
        if [ "$HAS_TOOLS" = "true" ]; then
            TOOL_COUNT=$(echo "$TOOLS_RESP" | jq '.result.tools | length')
            log_pass "Tools list response valid ($TOOL_COUNT tools found)"

            # List some tools if available
            if [ "$TOOL_COUNT" -gt 0 ]; then
                log_info "Sample tools:"
                echo "$TOOLS_RESP" | jq -r '.result.tools[:5] | .[].name' 2>/dev/null | while read -r tool; do
                    echo "  - $tool"
                done
            fi
        else
            # Check if it's an error response (e.g., not connected to VoxEdit)
            HAS_ERROR=$(echo "$TOOLS_RESP" | jq 'has("error")')
            if [ "$HAS_ERROR" = "true" ]; then
                ERROR_MSG=$(echo "$TOOLS_RESP" | jq -r '.error.message')
                log_info "Tools list returned error (expected if VoxEdit not running): $ERROR_MSG"
            else
                log_fail "Tools list response missing tools array"
            fi
        fi
    else
        log_fail "Tools list response is not valid JSON"
        echo "  Response: $TOOLS_RESP"
    fi
else
    log_info "No tools/list response (may need VoxEdit running)"
fi

echo ""

# Test 3: Invalid request handling
log_info "Test 3: Testing invalid request handling..."

INVALID_REQUEST='{"jsonrpc":"2.0","id":3,"method":"nonexistent/method"}'
INVALID_RESPONSE=$(echo -e "$INVALID_REQUEST" | timeout 5 "$MCP_SERVER" 2>/dev/null | head -1)

if [ -n "$INVALID_RESPONSE" ]; then
    if echo "$INVALID_RESPONSE" | jq . > /dev/null 2>&1; then
        HAS_ERROR=$(echo "$INVALID_RESPONSE" | jq 'has("error")')
        if [ "$HAS_ERROR" = "true" ]; then
            ERROR_CODE=$(echo "$INVALID_RESPONSE" | jq '.error.code')
            # -32601 is METHOD_NOT_FOUND
            if [ "$ERROR_CODE" = "-32601" ]; then
                log_pass "Invalid method correctly returns METHOD_NOT_FOUND error"
            else
                log_pass "Invalid method returns error (code: $ERROR_CODE)"
            fi
        else
            log_fail "Invalid method should return an error"
        fi
    else
        log_fail "Response to invalid request is not valid JSON"
    fi
else
    log_fail "No response to invalid request"
fi

echo ""

# Test 4: Malformed JSON handling
log_info "Test 4: Testing malformed JSON handling..."

MALFORMED='{"jsonrpc": "2.0", "id": 4, method: "test"}'  # Missing quotes around method key
MALFORMED_RESPONSE=$(echo -e "$MALFORMED" | timeout 5 "$MCP_SERVER" 2>/dev/null | head -1)

if [ -n "$MALFORMED_RESPONSE" ]; then
    if echo "$MALFORMED_RESPONSE" | jq . > /dev/null 2>&1; then
        HAS_ERROR=$(echo "$MALFORMED_RESPONSE" | jq 'has("error")')
        ERROR_CODE=$(echo "$MALFORMED_RESPONSE" | jq '.error.code')
        # -32700 is PARSE_ERROR
        if [ "$ERROR_CODE" = "-32700" ]; then
            log_pass "Malformed JSON correctly returns PARSE_ERROR"
        else
            log_pass "Malformed JSON returns error response (code: $ERROR_CODE)"
        fi
    else
        log_fail "Response to malformed JSON is not valid JSON itself"
    fi
else
    log_fail "No response to malformed JSON"
fi

echo ""

# Test 5: Missing jsonrpc version
log_info "Test 5: Testing missing jsonrpc version..."

NO_VERSION='{"id":5,"method":"initialize"}'
NO_VERSION_RESPONSE=$(echo -e "$NO_VERSION" | timeout 5 "$MCP_SERVER" 2>/dev/null | head -1)

if [ -n "$NO_VERSION_RESPONSE" ]; then
    if echo "$NO_VERSION_RESPONSE" | jq . > /dev/null 2>&1; then
        HAS_ERROR=$(echo "$NO_VERSION_RESPONSE" | jq 'has("error")')
        if [ "$HAS_ERROR" = "true" ]; then
            ERROR_CODE=$(echo "$NO_VERSION_RESPONSE" | jq '.error.code')
            # -32600 is INVALID_REQUEST
            if [ "$ERROR_CODE" = "-32600" ]; then
                log_pass "Missing jsonrpc version correctly returns INVALID_REQUEST"
            else
                log_pass "Missing jsonrpc version returns error (code: $ERROR_CODE)"
            fi
        else
            log_fail "Missing jsonrpc version should return an error"
        fi
    else
        log_fail "Response is not valid JSON"
    fi
else
    log_fail "No response received"
fi

echo ""

# Summary
echo "========================================"
echo -e "Tests passed: ${GREEN}$TESTS_PASSED${NC}"
echo -e "Tests failed: ${RED}$TESTS_FAILED${NC}"
echo "========================================"

if [ "$TESTS_FAILED" -gt 0 ]; then
    exit 1
fi

exit 0
